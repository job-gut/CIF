"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deviceModelMap = exports.nameMap = void 0;
const packetids_1 = require("bdsx/bds/packetids");
const common_1 = require("bdsx/common");
const event_1 = require("bdsx/event");
const main_1 = require("../main");
exports.nameMap = new Map();
exports.deviceModelMap = new Map();
var TitleId;
(function (TitleId) {
    TitleId[TitleId["ANDROID"] = 1739947436] = "ANDROID";
    TitleId[TitleId["IOS"] = 1810924247] = "IOS";
    TitleId[TitleId["WINDOWS_10"] = 896928775] = "WINDOWS_10";
    TitleId[TitleId["PLAYSTATION"] = 2044456598] = "PLAYSTATION";
    TitleId[TitleId["NINTENDO"] = 2047319603] = "NINTENDO";
    TitleId[TitleId["XBOX"] = 1828326430] = "XBOX";
})(TitleId || (TitleId = {}));
event_1.events.packetAfter(packetids_1.MinecraftPacketIds.Login).on((pkt, ni) => {
    if (pkt.connreq === null)
        return;
    const deviceId = pkt.connreq.getDeviceId();
    const deviceOS = pkt.connreq.getDeviceOS();
    const cert = pkt.connreq.getCertificate();
    const name = cert.getId();
    const ip = ni.getAddress();
    const xuid = cert.getXuid();
    const model = pkt.connreq.getJsonValue().DeviceModel;
    exports.nameMap.set(ni, name);
    exports.deviceModelMap.set(ni, model);
    if (name.length > 20) {
        main_1.CIF.detect(ni, "long_name", "Too long nickname");
    }
    if (name === "") {
        main_1.CIF.detect(ni, "invalid_name", "Nickname is null");
    }
    ;
    const invisibleChars = ["⠀", " ", " ", " ", "　", " ", " ", " ", " ", "﻿", " ", " ", "󠀠", " ", " ", "​", " "];
    for (let i = 0; i < invisibleChars.length; i++) {
        const char = invisibleChars[i];
        if (name.includes(char)) {
            main_1.CIF.detect(ni, "invisible_name", "Nickname includes disallowed space");
            return;
        }
    }
    const brand = model.split(" ")[0];
    const titleId = cert.json.value()["extraData"]["titleId"];
    if (TitleId[titleId] && TitleId[common_1.BuildPlatform[deviceOS]] != titleId) {
        main_1.CIF.detect(ni, "os_spoof", "Join with wrong edition");
    }
    if (brand.toUpperCase() !== brand && deviceOS !== 2) {
        main_1.CIF.detect(ni, "toolbox", "Join with Toolbox");
    }
    ;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam9pbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImpvaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0Esa0RBQXdEO0FBQ3hELHdDQUE0QztBQUM1QyxzQ0FBb0M7QUFDcEMsa0NBQThCO0FBR2pCLFFBQUEsT0FBTyxHQUFHLElBQUksR0FBRyxFQUE2QixDQUFDO0FBRS9DLFFBQUEsY0FBYyxHQUFHLElBQUksR0FBRyxFQUE2QixDQUFDO0FBRW5FLElBQUssT0FPSjtBQVBELFdBQUssT0FBTztJQUNSLG9EQUFvQixDQUFBO0lBQ3BCLDRDQUFnQixDQUFBO0lBQ2hCLHlEQUFzQixDQUFBO0lBQ3RCLDREQUF3QixDQUFBO0lBQ3hCLHNEQUFxQixDQUFBO0lBQ3JCLDhDQUFpQixDQUFBO0FBQ3JCLENBQUMsRUFQSSxPQUFPLEtBQVAsT0FBTyxRQU9YO0FBRUQsY0FBTSxDQUFDLFdBQVcsQ0FBQyw4QkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxFQUFFLEVBQUU7SUFDeEQsSUFBSSxHQUFHLENBQUMsT0FBTyxLQUFLLElBQUk7UUFBRSxPQUFPO0lBQ2pDLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDM0MsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUMzQyxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzFDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMxQixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDM0IsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQzNCLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFHLENBQUMsV0FBVyxDQUFDO0lBRXRELGVBQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RCLHNCQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUU5QixJQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxFQUFFO1FBQ2xCLFVBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0tBQ3BEO0lBRUQsSUFBSSxJQUFJLEtBQUssRUFBRSxFQUFFO1FBQ2IsVUFBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixDQUFDLENBQUM7S0FDdEQ7SUFBQSxDQUFDO0lBRUYsTUFBTSxjQUFjLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFFOUcsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDNUMsTUFBTSxJQUFJLEdBQUcsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNyQixVQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSxvQ0FBb0MsQ0FBQyxDQUFDO1lBQ3ZFLE9BQU87U0FDVjtLQUNKO0lBRUQsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsQyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRTFELElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxzQkFBYSxDQUFDLFFBQVEsQ0FBUSxDQUFDLElBQUksT0FBTyxFQUFFO1FBQ3hFLFVBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLFVBQVUsRUFBRSx5QkFBeUIsQ0FBQyxDQUFDO0tBQ3pEO0lBRUQsSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFLEtBQUssS0FBSyxJQUFJLFFBQVEsS0FBSyxDQUFDLEVBQUU7UUFDakQsVUFBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsU0FBUyxFQUFFLG1CQUFtQixDQUFDLENBQUM7S0FDbEQ7SUFBQSxDQUFDO0FBQ04sQ0FBQyxDQUFDLENBQUMifQ==