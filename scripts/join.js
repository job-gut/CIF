"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deviceModelMap = exports.nameMap = void 0;
const packetids_1 = require("bdsx/bds/packetids");
const common_1 = require("bdsx/common");
const event_1 = require("bdsx/event");
const colors_1 = require("colors");
const main_1 = require("../main");
exports.nameMap = new Map();
exports.deviceModelMap = new Map();
var TitleId;
(function (TitleId) {
    TitleId[TitleId["ANDROID"] = 1739947436] = "ANDROID";
    TitleId[TitleId["IOS"] = 1810924247] = "IOS";
    TitleId[TitleId["WINDOWS_10"] = 896928775] = "WINDOWS_10";
    TitleId[TitleId["PLAYSTATION"] = 2044456598] = "PLAYSTATION";
    TitleId[TitleId["NINTENDO"] = 2047319603] = "NINTENDO";
    TitleId[TitleId["XBOX"] = 1828326430] = "XBOX";
})(TitleId || (TitleId = {}));
;
const firstLoginedDID = {};
const firstLoginedOS = {};
event_1.events.packetAfter(packetids_1.MinecraftPacketIds.Login).on((pkt, ni) => {
    const req = pkt.connreq;
    if (req === null)
        return;
    const deviceId = req.getDeviceId();
    const deviceOS = req.getDeviceOS();
    const cert = req.getCertificate();
    const name = cert.getId();
    const ip = ni.getAddress();
    const xuid = cert.getXuid();
    const model = req.getJsonValue().DeviceModel;
    const isXboxLogined = xuid.length > 3;
    exports.nameMap.set(ni, name);
    exports.deviceModelMap.set(ni, model);
    //TODO : 밴 된 사람 처리하는 곳 만들기 (CIF.log & OP ALERT)
    if (name.length > 20) {
        exports.nameMap.set(ni, "Invalid_Name");
        main_1.CIF.detect(ni, "long_name", "Too long nickname");
        main_1.CIF.ban(ni, "Long_Name");
    }
    ;
    if (name === "") {
        exports.nameMap.set(ni, "Invalid_Name");
        main_1.CIF.detect(ni, "invalid_name", "Nickname is null");
        main_1.CIF.ban(ni, "Invalid_Name");
    }
    ;
    const invisibleChars = ["⠀", " ", " ", " ", "　", " ", " ", " ", " ", "﻿", " ", " ", "󠀠", " ", " ", "​", " "];
    for (let i = 0; i < invisibleChars.length; i++) {
        const char = invisibleChars[i];
        if (name.includes(char)) {
            exports.nameMap.set(ni, "Invalid_Name");
            main_1.CIF.detect(ni, "invisible_name", "Nickname includes disallowed space");
            main_1.CIF.ban(ni, "Invisible_Name");
        }
        ;
    }
    ;
    const brand = model.split(" ")[0];
    const titleId = cert.json.value()["extraData"]["titleId"];
    if (TitleId[titleId] && TitleId[common_1.BuildPlatform[deviceOS]] != titleId) {
        main_1.CIF.detect(ni, "os_spoof", "Join with wrong edition");
        main_1.CIF.ban(ni, "os-spoof");
    }
    ;
    if (brand.toUpperCase() !== brand && deviceOS !== 2 && model !== "To Be Filled By O.E.M. To Be Filled By O.E.M." && !model.includes("ASUS")) {
        main_1.CIF.detect(ni, "toolbox", "Join with Toolbox");
        main_1.CIF.ban(ni, "Toolbox");
    }
    ;
    main_1.CIF.log((0, colors_1.yellow)(`${exports.nameMap.get(ni)} > IP & Port: ${ip}, XUID: ${xuid}, Model: ${model}, DeviceId: ${deviceId}`));
    if (deviceId.length === 36) {
        if (deviceId.includes("g") || deviceId.includes("h") || deviceId.includes("i") || deviceId.includes("j") || deviceId.includes("k") || deviceId.includes("l") || deviceId.includes("m") || deviceId.includes("n") || deviceId.includes("o") || deviceId.includes("p") || deviceId.includes("q") || deviceId.includes("r") || deviceId.includes("s") || deviceId.includes("t") || deviceId.includes("u") || deviceId.includes("v") || deviceId.includes("w") || deviceId.includes("x") || deviceId.includes("y") || deviceId.includes("z")) {
            main_1.CIF.detect(ni, "zephyr", "Zephyr DeviceId Spoof");
            return main_1.CIF.ban(ni, "Zephyr DeviceId Spoof");
        }
        ;
    }
    ;
    if (typeof firstLoginedDID[name] !== "string" && isXboxLogined === true) {
        firstLoginedDID[name] = deviceId;
        firstLoginedOS[name] = deviceOS;
    }
    else if (isXboxLogined === true && firstLoginedDID[name] !== deviceId && firstLoginedOS[name] === deviceOS) {
        main_1.CIF.ban(ni, "deviceid_spoof");
        return main_1.CIF.detect(ni, "deviceid_spoof", "Spoofs their deviceID");
    }
    else {
        firstLoginedDID[name] = deviceId;
        firstLoginedOS[name] = deviceOS;
    }
    ;
    //nameMap.get(ni) -> do not log illegal names
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiam9pbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImpvaW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0Esa0RBQXdEO0FBQ3hELHdDQUE0QztBQUM1QyxzQ0FBb0M7QUFDcEMsbUNBQWdDO0FBQ2hDLGtDQUE4QjtBQUdqQixRQUFBLE9BQU8sR0FBRyxJQUFJLEdBQUcsRUFBNkIsQ0FBQztBQUUvQyxRQUFBLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBNkIsQ0FBQztBQUVuRSxJQUFLLE9BT0o7QUFQRCxXQUFLLE9BQU87SUFDUixvREFBb0IsQ0FBQTtJQUNwQiw0Q0FBZ0IsQ0FBQTtJQUNoQix5REFBc0IsQ0FBQTtJQUN0Qiw0REFBd0IsQ0FBQTtJQUN4QixzREFBcUIsQ0FBQTtJQUNyQiw4Q0FBaUIsQ0FBQTtBQUNyQixDQUFDLEVBUEksT0FBTyxLQUFQLE9BQU8sUUFPWDtBQUFBLENBQUM7QUFFRixNQUFNLGVBQWUsR0FBMkIsRUFBRSxDQUFDO0FBQ25ELE1BQU0sY0FBYyxHQUEyQixFQUFFLENBQUM7QUFFbEQsY0FBTSxDQUFDLFdBQVcsQ0FBQyw4QkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRSxFQUFFLEVBQUU7SUFDeEQsTUFBTSxHQUFHLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQztJQUN4QixJQUFJLEdBQUcsS0FBSyxJQUFJO1FBQUUsT0FBTztJQUN6QixNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDbkMsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ25DLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDMUIsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQzNCLE1BQU0s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QUFTLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztRQUMvQyxVQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQztLQUMxQjtJQUFBLENBQUM7SUFFRixVQUFHLENBQUMsR0FBRyxDQUFDLElBQUEsZUFBTSxFQUFDLEdBQUcsZUFBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsaUJBQWlCLEVBQUUsV0FBVyxJQUFJLFlBQVksS0FBSyxlQUFlLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVoSCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssRUFBRSxFQUFFO1FBQ3hCLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksUUFBUSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3RnQixVQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxRQUFRLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztZQUNsRCxPQUFPLFVBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLHVCQUF1QixDQUFDLENBQUM7U0FDL0M7UUFBQSxDQUFDO0tBQ0w7SUFBQSxDQUFDO0lBRUYsSUFBSSxPQUFPLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxRQUFRLElBQUksYUFBYSxLQUFLLElBQUksRUFBRTtRQUNyRSxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ2pDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7S0FDbkM7U0FBTSxJQUFJLGFBQWEsS0FBSyxJQUFJLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxLQUFLLFFBQVEsSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssUUFBUSxFQUFFO1FBQzFHLFVBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLGdCQUFnQixDQUFDLENBQUE7UUFDN0IsT0FBTyxVQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxnQkFBZ0IsRUFBRSx1QkFBdUIsQ0FBQyxDQUFDO0tBQ3BFO1NBQU07UUFDSCxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBQ2pDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUM7S0FDbkM7SUFBQSxDQUFDO0lBRUYsNkNBQTZDO0FBQ2pELENBQUMsQ0FBQyxDQUFDIn0=